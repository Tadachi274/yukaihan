<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>{{ player[1] }}ã®è©³ç´°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            padding: 0;
            background-color: #f9f9f9;
        }

        h1, h2 {
            color: #333;
        }

        form {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        input[type="radio"] {
            margin-right: 5px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        canvas {
            margin-top: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 400px; /* Set maximum width */
            max-height: 400px; /* Set maximum height */
        }

        a {
            display: inline-block;
            margin-top: 20px;
            color: #007bff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .chart-container {
            display: flex;
            
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .average-score {
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            width: 400px; 
            height: 400px; 
            display: flex; /* ä¸­å¤®æƒãˆã®ãŸã‚ã«è¿½åŠ  */
            flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦æ–¹å‘ã«ä¸¦ã¹ã‚‹ */
            align-items: center; /* ç¸¦æ–¹å‘ã®ä¸­å¤®æƒãˆ */
            justify-content: center; /* æ¨ªæ–¹å‘ã®ä¸­å¤®æƒãˆ */
            text-align: center;
        }

        #averageScore {
        font-size: 10px; /* åˆæœŸå€¤ã‚’è¨­å®š */
        width: 100%; /* å¹…ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
        height: 100%; /* é«˜ã•ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
        display: flex;
        align-items: center;
        justify-content: center;
        word-wrap: break-word; /* å¿…è¦ã«å¿œã˜ã¦æ”¹è¡Œ */
        }

        .motivation-input {
            margin-top: 10px;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .task-item.done {
            background: #f8f9fa;
            text-decoration: line-through;
        }

        .task-position {
            margin-right: 10px;
            color: #666;
        }

        .task-text {
            flex-grow: 1;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .task-item.done .task-text {
            text-decoration: line-through;
            color: #666;
        }

        .task-actions {
            display: flex;
            gap: 10px;
            margin-left: 10px;
        }

        .delete-button {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
        }

        .delete-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <h1>{{ player[1] }}ã®è©³ç´°</h1>
    <p><strong>åå‰:</strong> {{ player[1] }}</p>
    <p><strong>éƒ¨ç½²:</strong> {{ player[2] }}</p>

    <div class="chart-container">
        <canvas id="radarChart"></canvas>
    <div class="average-score">
        <h3>å¿™ã—ã•</h3> 
        <div class="score" id="averageScore">-</div>
    </div>
    <div class="average-score">
        <h3>ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</h3>
        <div class="score" id="motivationScore">-</div>
        <div class="motivation-input">
            <input type="range" id="motivation" min="0" max="100" value="{{ motivation }}">
            <button onclick="saveMotivation()">ãƒ¢ãƒãƒ™ã‚’ä¿å­˜</button>
        </div>
    </div>
    </div>

    <h2>ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ</h2>
    <ul id="taskList" class="task-list">
        {% for task in tasks %}
        <li class="task-item {% if task[3] %}done{% endif %}" data-id="{{ task[0] }}">
            <input type="checkbox" 
                   class="task-checkbox" 
                   onclick="toggleTask('{{ task[0] }}')"
                   {% if task[3] %}checked{% endif %}>
            <span class="task-position">[{{ task[1] }}]</span>
            <span class="task-text">{{ task[2] }}</span>
            <div class="task-actions">
                <button class="delete-button" onclick="deleteTask('{{ task[0] }}')">å‰Šé™¤</button>
            </div>
        </li>
        {% endfor %}
    </ul>

    <form id="taskForm">
        <input type="hidden" name="name" value="{{ player[1] }}">
        <div>
            <label for="position">éƒ¨ç½²:</label>
            <select id="position" name="position">
                <option value="æ¼”å‡º">æ¼”å‡º</option>
                <option value="èˆå°ç›£ç£" selected>èˆå°ç›£ç£</option>
                <option value="åˆ¶ä½œ">åˆ¶ä½œ</option>
                <option value="éŸ³éŸ¿">éŸ³éŸ¿</option>
                <option value="ç…§æ˜">ç…§æ˜</option>
                <option value="é“å…·">é“å…·</option>
                <option value="è¡£è£…">è¡£è£…</option>
                <option value="å®£ä¼ç¾è¡“">å®£ä¼ç¾è¡“</option>
                <option value="åºƒå ±">åºƒå ±</option>
                <option value="æ˜ åƒ">æ˜ åƒ</option>
                <option value="æ–°æ­“">æ–°æ­“</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <label for="task">ã‚¿ã‚¹ã‚¯:</label>
            <input type="text" id="task" name="task" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›" required>
            <button type="submit">è¿½åŠ </button>
        </div>
    </form>
    
    <h2>å¿™ã—ã•è©•ä¾¡</h2>
    <form id="form">
        <input type="hidden" name="name" id="name" value="{{ player[1] }}">

        <label>éƒ¨ç½²:</label>
        <div>
            <input type="radio" name="éƒ¨ç½²" value="1" required> 1
            <input type="radio" name="éƒ¨ç½²" value="2"> 2
            <input type="radio" name="éƒ¨ç½²" value="3"> 3
            <input type="radio" name="éƒ¨ç½²" value="4"> 4
            <input type="radio" name="éƒ¨ç½²" value="5"> 5
            <input type="radio" name="éƒ¨ç½²" value="6"> 6
            <input type="radio" name="éƒ¨ç½²" value="7"> 7
            <input type="radio" name="éƒ¨ç½²" value="10"> 10
        </div>

        <label>å½¹è€…:</label>
        <div>
            <input type="radio" name="å½¹è€…" value="1" required> 1
            <input type="radio" name="å½¹è€…" value="2"> 2
            <input type="radio" name="å½¹è€…" value="3"> 3
            <input type="radio" name="å½¹è€…" value="4"> 4
            <input type="radio" name="å½¹è€…" value="5"> 5
            <input type="radio" name="å½¹è€…" value="6"> 6
            <input type="radio" name="å½¹è€…" value="7"> 7
            <input type="radio" name="å½¹è€…" value="10"> 10
        </div>

        <label>å¤§å­¦:</label>
        <div>
            <input type="radio" name="å¤§å­¦" value="1" required> 1
            <input type="radio" name="å¤§å­¦" value="2"> 2
            <input type="radio" name="å¤§å­¦" value="3"> 3
            <input type="radio" name="å¤§å­¦" value="4"> 4
            <input type="radio" name="å¤§å­¦" value="5"> 5
            <input type="radio" name="å¤§å­¦" value="6"> 6
            <input type="radio" name="å¤§å­¦" value="7"> 7
            <input type="radio" name="å¤§å­¦" value="10"> 10
        </div>

        <label>ä»–å›£ä½“:</label>
        <div>
            <input type="radio" name="ä»–å›£ä½“" value="1" required> 1
            <input type="radio" name="ä»–å›£ä½“" value="2"> 2
            <input type="radio" name="ä»–å›£ä½“" value="3"> 3
            <input type="radio" name="ä»–å›£ä½“" value="4"> 4
            <input type="radio" name="ä»–å›£ä½“" value="5"> 5
            <input type="radio" name="ä»–å›£ä½“" value="6"> 6
            <input type="radio" name="ä»–å›£ä½“" value="7"> 7
            <input type="radio" name="ä»–å›£ä½“" value="10"> 10
        </div>

        <label>ãƒã‚¤ãƒˆ:</label>
        <div>
            <input type="radio" name="ãƒã‚¤ãƒˆ" value="1" required> 1
            <input type="radio" name="ãƒã‚¤ãƒˆ" value="2"> 2
            <input type="radio" name="ãƒã‚¤ãƒˆ" value="3"> 3
            <input type="radio" name="ãƒã‚¤ãƒˆ" value="4"> 4
            <input type="radio" name="ãƒã‚¤ãƒˆ" value="5"> 5
            <input type="radio" name="ãƒã‚¤ãƒˆ" value="6"> 6
            <input type="radio" name="ãƒã‚¤ãƒˆ" value="7"> 7
            <input type="radio" name="ãƒã‚¤ãƒˆ" value="10"> 10
        </div>

        <label>ãã®ä»–:</label>
        <div>
            <input type="radio" name="ãã®ä»–" value="1" required> 1
            <input type="radio" name="ãã®ä»–" value="2"> 2
            <input type="radio" name="ãã®ä»–" value="3"> 3
            <input type="radio" name="ãã®ä»–" value="4"> 4
            <input type="radio" name="ãã®ä»–" value="5"> 5
            <input type="radio" name="ãã®ä»–" value="6"> 6
            <input type="radio" name="ãã®ä»–" value="7"> 7
            <input type="radio" name="ãã®ä»–" value="10"> 10
        </div>

        <button type="submit">é€ä¿¡</button>
    </form>
    
    <script>
        let radarChart;
        
        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã§ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
        window.onload = function() {
            // Flaskã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
            let initialData = {
                name: "{{ player[1] }}",  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å›ºå®š
                éƒ¨ç½²: "{{ player_data.éƒ¨ç½² if player_data else 1 }}",
                å½¹è€…: "{{ player_data.å½¹è€… if player_data else 1 }}",
                å¤§å­¦: "{{ player_data.å¤§å­¦ if player_data else 1 }}",
                ä»–å›£ä½“: "{{ player_data.ä»–å›£ä½“ if player_data else 1 }}",
                ãƒã‚¤ãƒˆ: "{{ player_data.ãƒã‚¤ãƒˆ if player_data else 1 }}",
                ãã®ä»–: "{{ player_data.ãã®ä»– if player_data else 1 }}"
            };
            updateChart(initialData);
            
            if ("{{ player_data }}") {
                document.querySelector(`input[name="éƒ¨ç½²"][value="{{ player_data.éƒ¨ç½² }}"]`).checked = true;
                document.querySelector(`input[name="å½¹è€…"][value="{{ player_data.å½¹è€… }}"]`).checked = true;
                document.querySelector(`input[name="å¤§å­¦"][value="{{ player_data.å¤§å­¦ }}"]`).checked = true;
                document.querySelector(`input[name="ä»–å›£ä½“"][value="{{ player_data.ä»–å›£ä½“ }}"]`).checked = true;
                document.querySelector(`input[name="ãƒã‚¤ãƒˆ"][value="{{ player_data.ãƒã‚¤ãƒˆ }}"]`).checked = true;
                document.querySelector(`input[name="ãã®ä»–"][value="{{ player_data.ãã®ä»– }}"]`).checked = true;
            }
            updateMotivationEmoji("{{ motivation }}");
        };

        document.getElementById("form").addEventListener("submit", function(event) {
            event.preventDefault();
            let formData = new FormData(event.target);
            let data = {};
            formData.forEach((value, key) => { data[key] = value; });

            fetch("/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(response => response.json())
              .then(() => {
                  alert("ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
                  updateChart(data);
              });
        });

        // ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã®è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById('motivation').addEventListener('input', function(e) {
            updateMotivationEmoji(e.target.value);
        });

        function updateMotivationEmoji(value) {
            const motivationScoreElement = document.getElementById('motivationScore');
            const score = parseInt(value);
            
            // å€¤ã«å¿œã˜ã¦é¡”æ–‡å­—ã‚’è¨­å®š
            if (score > 80) {
                motivationScoreElement.textContent = "ğŸ¤©";
            } else if (score > 60) {
                motivationScoreElement.textContent = "ğŸ˜Š";
            } else if (score > 40) {
                motivationScoreElement.textContent = "ğŸ˜";
            } else if (score > 20) {
                motivationScoreElement.textContent = "ğŸ˜•";
            } else if (score > 10) {
                motivationScoreElement.textContent = "ğŸ˜¢";
            } else {
                motivationScoreElement.textContent = "ğŸ¥¶";
            }

            // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´
            const parentWidth = motivationScoreElement.parentElement.offsetWidth;
            const parentHeight = motivationScoreElement.parentElement.offsetHeight;
            const fontSize = Math.min(parentWidth, parentHeight) * 0.5;
            motivationScoreElement.style.fontSize = `${fontSize}px`;
        }

        // ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
        function saveMotivation() {
            const motivation = document.getElementById('motivation').value;
            const playerName = "{{ player[1] }}";

            fetch("/save_motivation", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: playerName,
                    motivation: motivation
                })
            }).then(response => response.json())
              .then(() => {
                  alert("ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
                  updateMotivationEmoji(motivation);
              });
        }

        function updateChart(data) {
            // å¹³å‡å€¤ã‚’è¨ˆç®—
            const scores = [
                parseFloat(data["éƒ¨ç½²"]),
                parseFloat(data["å½¹è€…"]),
                parseFloat(data["å¤§å­¦"]),
                parseFloat(data["ä»–å›£ä½“"]),
                parseFloat(data["ãƒã‚¤ãƒˆ"]),
                parseFloat(data["ãã®ä»–"])
            ];
            const average = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
            const averageScoreElement = document.getElementById("averageScore");

            // å¿™ã—ã•ã‚¹ã‚³ã‚¢ã®è¡¨ç¤ºå†…å®¹ã‚’æ›´æ–°
            if (average > 4.5) {
                averageScoreElement.textContent = "ğŸ¥µ";
            } else if (average > 3.5) {
                averageScoreElement.textContent = "ğŸ˜±";
            } else if (average > 3.0) {
                averageScoreElement.textContent = "ğŸ˜¨";
            } else if (average > 2.5) {
                averageScoreElement.textContent = "ğŸ˜";
            } else if (average > 1.5) {
                averageScoreElement.textContent = "ğŸ˜Š";
            } else {
                averageScoreElement.textContent = "ğŸ˜„";
            }

            // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¯„å›²å†…ã„ã£ã±ã„ã«èª¿æ•´
            const parentWidth = averageScoreElement.parentElement.offsetWidth;
            const parentHeight = averageScoreElement.parentElement.offsetHeight;
            const fontSize = Math.min(parentWidth, parentHeight) * 0.5; // è¦ªè¦ç´ ã®50%ã‚’åŸºæº–ã«è¨­å®š
            averageScoreElement.style.fontSize = `${fontSize}px`;

            let ctx = document.getElementById("radarChart").getContext("2d");
            let chartData = {
                labels: ["éƒ¨ç½²", "å½¹è€…", "å¤§å­¦", "ä»–å›£ä½“", "ãƒã‚¤ãƒˆ", "ãã®ä»–"],
                datasets: [{
                    label: data.name + "ã®å¿™ã—ã•ã‚¹ã‚³ã‚¢",
                    data: [data["éƒ¨ç½²"], data["å½¹è€…"], data["å¤§å­¦"], data["ä»–å›£ä½“"], data["ãƒã‚¤ãƒˆ"], data["ãã®ä»–"]],
                    backgroundColor: "rgba(54, 162, 235, 0.2)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 2
                }]
            };

            if (radarChart) {
                radarChart.destroy();
            }
            radarChart = new Chart(ctx, { type: "radar", data: chartData, options: { scales: { r: { min: 1, max: 5, ticks: { stepSize: 1 } } } } });
        }

        // ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜
        function saveTask() {
            const task = document.getElementById('task').value;
            const position = document.getElementById('position').value;
            const playerName = "{{ player[1] }}";

            fetch("/save_task", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: playerName,
                    position: position,
                    tasks: task
                })
            }).then(response => response.json())
              .then(() => {
                  alert("ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
              });
        }

        // ã‚¿ã‚¹ã‚¯è¿½åŠ ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        document.getElementById('taskForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const taskData = {
                name: "{{ player[1] }}",
                position: document.getElementById('position').value,
                task: document.getElementById('task').value
            };

            fetch('/save_task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            })
            .then(response => response.json())
            .then(() => {
                location.reload(); // ç”»é¢ã‚’æ›´æ–°ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
            });
        });

        // ã‚¿ã‚¹ã‚¯ã®å®Œäº†çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleTask(taskId) {
            fetch(`/toggle_task/${taskId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(() => {
                const taskItem = document.querySelector(`[data-id="${taskId}"]`);
                taskItem.classList.toggle('done');
            });
        }

        // ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤
        function deleteTask(taskId) {
            if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                fetch(`/delete_task/${taskId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(() => {
                    const taskItem = document.querySelector(`[data-id="${taskId}"]`);
                    taskItem.remove();
                });
            }
        }
        
    </script>
    
    <a href="{{ url_for('index') }}">åº§çµ„ä¸€è¦§ã«æˆ»ã‚‹</a>
</body>
</html>
